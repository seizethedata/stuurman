<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
      }

      #mapid {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="mapid"></div>
    <script>
      var mymap = L.map('mapid').setView([55.75, 37.65], 13);

      L.tileLayer('https://api.mapbox.com/styles/v1/walkmap/cizpnte4900gh2rplobw8pgu0/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoid2Fsa21hcCIsImEiOiJjaXI0d285eXIwMDR1aHRtOWQ3YWE3d2JtIn0.pqyo1f-gocUK9i819vmQBQ', {
        maxZoom: 18,
        id: 'mapbox.streets'
      }).addTo(mymap);

      function getColor(d) {
        switch (d) {
          case 3:
            return '#73AC61';
            break;
          case 2:
            return '#A6C760';
            break;
          case 1:
            return '#E2E062';
            break;
        }
      }

      function getNoiseColor(d) {
        switch (d) {
          case 3:
            return '#FADA70';
            break;
          case 2:
            return '#F5C063';
            break;
          case 1:
            return '#EB944D';
            break;
        }
      }

      function getAirColor(d) {
        switch (d) {
          case 3:
            return '#3182bd';
            break;
          case 2:
            return '#9ecae1';
            break;
          case 1:
            return '#deebf7';
            break;
        }
      }


      function style(feature) {
        return {
          color: getColor(feature.properties.color),
          weight: 4
        };
      }

      function noiseStyle(feature) {
        return {
          color: getNoiseColor(feature.properties.color),
          weight: 4
        };
      }

      function airStyle(feature) {
        return {
          color: getAirColor(feature.properties.color),
          weight: 4
        };
      }

      function underStyle(hex) {
        return {
          color: hex,
          weight: 5
        };
      }

      const markerStart = L.marker([55.75, 37.67], { draggable: 'true' })
        .addTo(mymap);
      const markerFinish = L.marker([55.77, 37.69], { draggable: 'true' })
        .addTo(mymap);

      var greenUrl = '/green';
      var noiseUrl = '/noise';
      var airUrl = '/air';

      var params = {
        x1: 37.69,
        y1: 55.75,
        x2: 37.69,
        y2: 55.77
      };
      var d = new FormData();

      d.append("json", JSON.stringify(params));
      var myLayer = L.geoJSON().addTo(mymap);
      var underLayer = L.geoJSON().addTo(mymap);
      var noiseLayer = L.geoJSON().addTo(mymap);
      var airLayer = L.geoJSON().addTo(mymap);
      var underNoiseLayer = L.geoJSON().addTo(mymap);
      var underAirLayer = L.geoJSON().addTo(mymap);

      fetch(greenUrl, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
          Accept: 'application/json'
        },
        body: JSON.stringify(params)
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (resp) {
          myLayer.addData(resp);
          underLayer.addData(resp);
        });

      fetch(noiseUrl, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
          Accept: 'application/json'
        },
        body: JSON.stringify(params)
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (resp) {
          noiseLayer.addData(resp);
          underNoiseLayer.addData(resp);
        });

      fetch(airUrl, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
          Accept: 'application/json'
        },
        body: JSON.stringify(params)
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (resp) {
          noiseLayer.addData(resp);
          underNoiseLayer.addData(resp);
        });

      markerStart.on('dragend',
        function (event) {
          var marker = event.target;
          var startPosition = marker.getLatLng();
          var params = {
            x1: startPosition.lng,
            y1: startPosition.lat,
            x2: markerFinish.getLatLng().lng,
            y2: markerFinish.getLatLng().lat
          };

          var d = new FormData();
          d.append("json", JSON.stringify(params));
          fetch(greenUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              myLayer.clearLayers();
              underLayer.clearLayers();
              underLayer = L.geoJSON(resp, { style: underStyle('#498F60') }).addTo(mymap)
              myLayer = L.geoJSON(resp, { style: style }).addTo(mymap)
            });
          fetch(noiseUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              noiseLayer.clearLayers();
              underNoiseLayer.clearLayers();
              noiseLayer = L.geoJSON(resp, { style: underStyle('#CD5031') }).addTo(mymap)
              underNoiseLayer = L.geoJSON(resp, { style: noiseStyle }).addTo(mymap)
            });
          fetch(airUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              airLayer.clearLayers();
              underAirLayer.clearLayers();
              airLayer = L.geoJSON(resp, { style: underStyle('#CD5031') }).addTo(mymap)
              underAirLayer = L.geoJSON(resp, { style: airStyle }).addTo(mymap)
            });
        }
      );

      markerFinish.on('dragend',
        function (event) {
          var marker = event.target;
          var finishPosition = marker.getLatLng();
          var params = {
            x1: markerStart.getLatLng().lng,
            y1: markerStart.getLatLng().lat,
            x2: finishPosition.lng,
            y2: finishPosition.lat
          };

          var d = new FormData();
          d.append("json", JSON.stringify(params));
          fetch(greenUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              //return L.geoJSON(JSON.stringify(resp)).addTo(mymap);
              myLayer.clearLayers();
              underLayer.clearLayers();
              //myLayer.addData(resp);
              underLayer = L.geoJSON(resp, { style: underStyle('#498F60') }).addTo(mymap)
              myLayer = L.geoJSON(resp, { style: style }).addTo(mymap)
            });
          fetch(noiseUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              noiseLayer.clearLayers();
              underNoiseLayer.clearLayers();
              noiseLayer = L.geoJSON(resp, { style: underStyle('#CD5031') }).addTo(mymap)
              underNoiseLayer = L.geoJSON(resp, { style: noiseStyle }).addTo(mymap)
            });
            fetch(airUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Access-Control-Allow-Origin': '*',
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(params)
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (resp) {
              airLayer.clearLayers();
              underAirLayer.clearLayers();
              airLayer = L.geoJSON(resp, { style: underStyle('#CD5031') }).addTo(mymap)
              underAirLayer = L.geoJSON(resp, { style: airStyle }).addTo(mymap)
            });
        }
      );
    </script>
  </body>
</html>